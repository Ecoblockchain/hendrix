# Topology definition
# name to be used when submitting
name: "HendrixRulesTopology"

# NOTE: We may want to consider some level of spring integration. For example, allowing component references
# to a spring `ApplicationContext`.

# topology configuration
# this will be passed to the submitter as a map of config options
#
config:
    topology.workers: 2
    store.sql.url: "jdbc:mysql://192.168.99.101:32770/"
    store.username: "root"
    store.password: "root"
    store.sql.db: "hendrix"
    rstore.type: "io.symcpe.hendrix.storm.SQLRulesStore"
    tstore.type: "io.symcpe.hendrix.storm.SQLRulesStore"
    rstore.sql.table: "rules_table"
    tstore.sql.table: "alert_template"
    rule.group.active: "true"
    mode: "metric"
    log.slow: "1000"
    ui.endpoint: "http://192.168.99.101:9000/api/receive/"

# Components
# Components are analagous to Spring beans. They are meant to be used as constructor,
# property(setter), and builder arguments.
#
# for the time being, components must be declared in the order they are referenced
components:
  - id: "zkHosts"
    className: "storm.kafka.ZkHosts"
    constructorArgs:
      - "localhost:2181"

  - id: "logSpoutConfig"
    className: "storm.kafka.SpoutConfig"
    constructorArgs:
      # brokerHosts
      - ref: "zkHosts"
      # topic
      - "logTopic"
      # zkRoot
      - "/"
      # id
      - "logTopic"
    properties:
      - name: "ignoreZkOffsets"
        value: false
      - name: "bufferSizeBytes"
        value: 2097152
#      - name: "fetchMaxWait"
#        value:
      - name: "fetchSizeBytes"
        value: 2097152

  - id: "ruleSpoutConfig"
    className: "storm.kafka.SpoutConfig"
    constructorArgs:
      # brokerHosts
      - ref: "zkHosts"
      # topic
      - "rulesTopic"
      # zkRoot
      - "/"
      # id
      - "rulesTopic"
    properties:
      - name: "ignoreZkOffsets"
        value: false
      - name: "bufferSizeBytes"
        value: 1048576
#      - name: "fetchMaxWait"
#        value:
      - name: "fetchSizeBytes"
        value: 1048576

# spout definitions
spouts:
  - id: "logSpout"
    className: "io.symcpe.hendrix.storm.bolts.helpers.FileLogReaderSpout"
#    className: "storm.kafka.KafkaSpout"
#    constructorArgs:
#      - ref: "logSpoutConfig"
    constructorArgs:
      - "~/hendrix/test-data"

  - id: "ruleSpout"
    className: "io.symcpe.hendrix.storm.bolts.helpers.SpoolingFileSpout"
    constructorArgs:
      - "~/hendrix/rule-updates.txt"
    
#    className: "storm.kafka.KafkaSpout"
#    constructorArgs:
#      - ref: "ruleSpoutConfig"

# bolt definitions
bolts:
  - id: "validationBolt"
    className: "io.symcpe.hendrix.storm.bolts.InterceptionBolt"
    parallelism: 1

    # ...
  - id: "translatorBolt"
    className: "io.symcpe.hendrix.storm.bolts.JSONTranslatorBolt"
    parallelism: 1

    # ...
  - id: "templateTranslatorBolt"
    className: "io.symcpe.hendrix.storm.bolts.TemplateTranslatorBolt"
    parallelism: 1

    # ...
  - id: "ruleTranslatorBolt"
    className: "io.symcpe.hendrix.storm.bolts.RuleTranslatorBolt"
    parallelism: 1

    # ...
  - id: "ruleEngineBolt"
    className: "io.symcpe.hendrix.storm.bolts.RulesEngineBolt"
    parallelism: 1

    # ...
  - id: "alertViewerBolt"
    className: "io.symcpe.hendrix.storm.bolts.helpers.AlertViewerBolt"
    parallelism: 1

    # ...
  - id: "templatedAlertEngineBolt"
    className: "io.symcpe.hendrix.storm.bolts.TemplatedAlertingEngineBolt"
    parallelism: 1

    # ...
  - id: "errorBolt"
    className: "io.symcpe.hendrix.storm.bolts.ErrorBolt"
    parallelism: 1

  - id: "printerBolt"
    className: "io.symcpe.hendrix.storm.bolts.helpers.PrinterBolt"
    parallelism: 1

#stream definitions
# stream definitions define connections between spouts and bolts.
# note that such connections can be cyclical
# custom stream groupings are also supported

streams:
  # Log Spout
  - name: "Kafka->Validation" # name isn't used (placeholder for logging, UI, etc.)
    from: "logSpout"
    to: "validationBolt"
    grouping:
      type: SHUFFLE

  # Rule Spout
  - name: "Kafka Rules->Rule Translator"
    from: "ruleSpout"
    to: "ruleTranslatorBolt"
    grouping:
      type: SHUFFLE
      
  - name: "Kafka Templates->Template Translator"
    from: "ruleSpout"
    to: "templateTranslatorBolt"
    grouping:
      type: SHUFFLE

  - name: "Validation->Translator"
    from: "validationBolt"
    to: "translatorBolt"
    grouping:
      type: SHUFFLE

  - name: "Translator->Rule Engine"
    from: "translatorBolt"
    to: "ruleEngineBolt"
    grouping:
      type: SHUFFLE
      
  - name: "Rule Engine->Templated Alert Engine"
    from: "ruleEngineBolt"
    to: "templatedAlertEngineBolt"
    grouping:
      type: SHUFFLE
      streamId: "alertStream"

  - name: "Print Alerts"
    from: "translatorBolt"
    to: "printerBolt"
    grouping:
      type: SHUFFLE

  - name: "Rule Translator->Rule Engine"
    from: "ruleTranslatorBolt"
    to: "ruleEngineBolt"
    grouping:
      type: ALL
      streamId: "syncStream"
      
  - name: "Template Translator->Templated Alert Engine"
    from: "templateTranslatorBolt"
    to: "templatedAlertEngineBolt"
    grouping:
      type: ALL
      streamId: "syncStream"

  - name: "Translator->Error"
    from: "translatorBolt"
    to: "errorBolt"
    grouping:
      type: SHUFFLE
      streamId: "errorStream"

  - name: "Rule Translator->Error"
    from: "ruleTranslatorBolt"
    to: "errorBolt"
    grouping:
      type: SHUFFLE
      streamId: "errorStream"
      
  - name: "Rule Translator->Error"
    from: "ruleTranslatorBolt"
    to: "errorBolt"
    grouping:
      type: SHUFFLE
      streamId: "errorStream"

  - name: "Rule Engine->Error"
    from: "ruleEngineBolt"
    to: "errorBolt"
    grouping:
      type: SHUFFLE
      streamId: "errorStream"
      
  - name: "Templated Alert Engine->Error"
    from: "templatedAlertEngineBolt"
    to: "errorBolt"
    grouping:
      type: SHUFFLE
      streamId: "errorStream"

  - name: "Error->Printer"
    from: "errorBolt"
    to: "printerBolt"
    grouping:
      type: SHUFFLE
      streamId: "kafkaErrorStream"